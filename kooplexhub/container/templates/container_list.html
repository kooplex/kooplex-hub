{% extends "container_layout.html" %}

{% load static %}

{% block pagedescription %}
Environments are user workspaces with limited resources, attached volumes and projects. Multiple environments can be running can run at the same time. <a href="https://xwiki.vo.elte.hu/en/kooplex-manual/environmentpanel"><span class="ms-2 bi bi-book"></span></a>
{% endblock %}

{# the search bar #}
{% block search %}
{% if containers %}
<div class="card border border-light border-3 mx-5 mb-3 rounded-3">
  <div class="input-group">
    <div class="input-group-prepend">
      <div class="input-group-text"><span class="bi bi-search"></span></div>
    </div>
    <input class="form-control" type="text" id="search_container" placeholder="Search by container name" autofocus value="{{ search_container }}">
  </div>
  {# FIXME: toggler to narrow selection according to whether a report container #}
</div>
{% endif %}
{% endblock %}


{# render the container cards #}
{% block bodycontent %}
<div id="containerListPane" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 w-100 mx-auto justify-content-center">
  {% if containers %}
    {% for container in containers %}
      <div class="col" id="hideable-container-{{ container.id }}">
        {% include partial %} {# FIXME: partial as a variable breaks code symmetry with report #}
      </div>
    {% endfor %}
  {% else %}
    {% include 'empty.html' %}
  {% endif %}
</div>

{# a modal to configure a container or display its logs #}
<div class="modal modal-xl fade" id="containerInfoModal" tabindex="-1" aria-labelledby="containerInfoModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="container-manage" class="form-horizontal was-validated" 
            action="{{ url_post }}"
            method="post">
        {% csrf_token %}
	<input type="hidden" id="containerid" name="containerid" value="{{ container_id }}">
	{% block form %}
	<div id="containerInfoModal-content"></div>
	{% endblock %}
      </form>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>

{% if form %}
$(document).ready(function() {
  m = $("#containerInfoModal")
  console.log( m )
  m.modal("show")
})
{% endif %}

var containerSocket = open_ws('{{ wss_container }}', ws_callback)

{# make sure search string we got gets applied #}
$("#search_container").keyup();

{# open a container #}
function open_container(containerid) {
  var url = $( "#url-containeropen-" + containerid).val();
  console.log( "opening: " + url );
  var win = window.open(url, '_blank');
  if (win) {
    win.focus();
  }
}

{# handle websocket callback #}
function ws_callback(data) {
  console.log(data);
  containerid = data['container-id'];
  if ('w_state' in data) {
    $("#containerstate-" + containerid).replaceWith(data['w_state'])
  }
  if ('w_startopen' in data) {
    $("#container-startopen-" + containerid).replaceWith(data['w_startopen'])
  }
  if ('w_stop' in data) {
    $("#container-stop-" + containerid).replaceWith(data['w_stop'])
  }
  if ('w_restart' in data) {
    $("#container-restart-" + containerid).replaceWith(data['w_restart'])
  }
  if ('w_image' in data) {
    $("#container-image-" + containerid).replaceWith(data['w_image'])
  }
  if ('w_modal' in data) {
    $("#containerInfoModal-content").replaceWith(data['w_modal'])
    $("#container-manage").attr('action', data['action'])
    $("#containerid").val(data['container-id'])
    $("#containerInfoModal").modal("show")
    {# refresh logs #}
    $("#container-manage li a[id=tab-logs]").click(function() {
      containerSocket.send(JSON.stringify({
        'command': 'container-log',
        'container-id': data['container-id'],
      }))
    })
  }
  if ('podlog' in data) {
    $("#logs").text(data['podlog'])
  }
}

{# catch submit event, in order to fill properly the share volume information #}
$("#container-manage").submit(function (e) {
  bind_project_ids = $.map($("input[id^=projecttoggler-]"), function (k, v) { if ($(k).prop('checked')) { return $(k).val() } }); 
  bind_course_ids = $.map($("input[id^=coursetoggler-]"), function (k, v) { if ($(k).prop('checked')) { return $(k).val() } }); 
  bind_volume_ids = $.map($("input[id^=volumetoggler-]"), function (k, v) { if ($(k).prop('checked')) { return $(k).val() } }); 
  $("#id_container_config").val(JSON.stringify( {
    'user_id': {{ user.id }},
    'container_id': $("#containerid").val(),
    'bind_project_ids': bind_project_ids,
    'bind_course_ids': bind_course_ids,
    'bind_volume_ids': bind_volume_ids
  }))
	alert($("#id_container_config").val())
});

{# catch modal close event #}
click_x = false
$("#containerInfoModal").on("hidden.bs.modal", function (ev, o) {
  url_list = '{{ url_list }}#'
  if (click_x) {
    click_x = false
    if (! window.location.href.endsWith(url_list)) {
      window.location.href = url_list
    }
  } else {
    if (! window.location.href.endsWith(url_list)) {
      if (confirm('Are you sure you want to discard changes?')) {
        window.location.href = url_list
      } else {
        $("#containerInfoModal").modal("show")
      }
    }
  }
});

{# start/restart/stop/open a container, or refresh log clicked in the modal #}
function handle_click(w) {
  containerid = $(w).attr('id').split('-')[2];
  command = $(w).children("input[name=target]").val();
  if (command == "open") {
    open_container(containerid);
    return;
  }
  if (containerSocket.readyState != 1) {
    console.log("Socket not open: " + containerSocket.readyState);
    containerSocket = open_ws('{{ wss_container }}', ws_callback);
  }
  console.log( command + ": " + containerid );
  containerSocket.send(JSON.stringify({
    'command': command,
    'container-id': containerid,
  }));
}

{# on mouse over the card show the buttonbars #}
$("div[id^=hideable-container-]").mouseenter(function() {
  var containerid = $( this ).attr("id").split("-", 3)[2];
  // console.log( "card enter: " + containerid );
  bar = $( "#buttonbar-" + containerid );
  bar.removeClass("opacity-25");
  bar.addClass("opacity-100");
});

{# hide buttons on mouse leaving the card #}
$("div[id^=hideable-container-]").mouseleave(function() {
  var containerid = $( this ).attr("id").split("-", 3)[2];
  // console.log( "card leave: " + containerid );
  bar = $( "#buttonbar-" + containerid );
  bar.removeClass("opacity-100");
  bar.addClass("opacity-25");
  
});

{# check if the card belongs to a running container #}
function is_running(w) {
  var containerid = $(w).attr('id').split('-', 3)[2];
  return ! $("#container-open-" + containerid).hasClass('d-none');
  //return ! $("#container-open-" + containerid).hasClass('d-opacity20');
}

{# when mouse enters the clickable part of the card change the cursor to pointer #}
$("[id^=click-]").mouseenter(function() {
  if (is_running(this)) {
    $( this ).css("cursor", "pointer");
  }
});

{# clickng the card header/body opens the environment #}
$("div[id^=click-]").click(function() {
  if (is_running(this)) {
    open_container( $( this ).attr("id").split("-", 3)[2] )
  }
})

//FIXME: maybe this is something to be put in common
{# make sure socket is open #}
function check_sock(sock, wss, callback) {
  if (sock.readyState != 1) {
    console.log("Socket not open: " + sock.readyState)
    sock = open_ws(wss, callback)
    console.log("and now: " + sock.readyState)
  }
  return sock
}

{# handle container configuration #}
function configure(cid) {
  s = check_sock(containerSocket, '{{ wss_container }}', ws_callback)
  s.send(JSON.stringify({
    'command': 'configure',
    'container-id': cid,
  }));
	containerSocket = s
}

//  {# clickng the card header/body opens the environment #}
//  $("div[id^=click-]").click(function() {
//    if (is_running(this)) {
//      open_container( $( this ).attr("id").split("-", 3)[2] );
//    }
//  });

</script>
{% endblock %}
