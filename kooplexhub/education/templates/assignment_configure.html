{% extends "assignment.html" %}

{% load render_table from django_tables2 %}
{% load extras %}

{% block child_head %}
<!-- datetime picker requirements -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js"
      crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/Eonasdan/tempus-dominus@master/dist/js/tempus-dominus.js"
      crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/gh/Eonasdan/tempus-dominus@master/dist/css/tempus-dominus.css"
      rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" 
	integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- bootstrap-toggler requirement -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/css/bootstrap5-toggle.min.css" rel="stylesheet">
{% endblock %}

{% block assignment_content %}
<div class="tab-pane fade {% if active == "conf" %}show active{% endif %} py-3" id="confAssignment" role="tabpanel" aria-labelledby="tab-conf">
  {% if form.okay %}
    <div class="input-group my-3">
      <span class="input-group-text"><span class="bi bi-search"></span></span>
      <input class="form-control" type="text" id="search_assignment" placeholder="Search course or assignment" title="Type in a name">
    </div>
    <form id='assignment-form-configure' class="was-validated" action="{% url 'education:assignment_configure' %}" method="post">
      {% csrf_token %}
        {% apply_cancel with icon_apply="bi bi-save" %}
      <table class="mt-3">{{ form.as_table }}</table>
      <div>
        {% render_table form.t_assignments %}
      </div>
    </form>
  {% else %}
  FIXME: empty
  {%endif %}
</div>
{% endblock %}

{% block child_scripts %}
<script>
function my_filter(obj, obj_id, convert) {
  obj_val = $("#" + obj + "-" + obj_id).val();
  old_val = $("#" + obj + "-old-" + obj_id).val();
  if (convert === "bool") {
    obj_val = B(obj_val);
    old_val = B(old_val);
    if (obj_val != old_val) {
      return { "attribute": obj, "value": obj_val };
    }
  }
  if ((obj_val !== undefined) && (obj_val.length > 0) && (obj_val != old_val)) {
    return { "attribute": obj, "value": obj_val };
  }
}
{# catch submit event, in order to see what is changed #}
$("#assignment-form-configure").submit(function (e) {
  changes = Array();
  $("input[name^=name-old-]").each(function() {
    aid = $( this ).attr('id').split('-', 3)[2];
    attrs = ["name", "description", "max_size", "remove_collected"]; //FIXME: handle dates
    attr_tp = ["str", "str", "str", "bool"]; //FIXME: handle dates
    a_chg = Array();
    for (k in attrs) {
      v = my_filter(attrs[k], aid, attr_tp[k]);
      if (v !== undefined) {
        a_chg.push(v)
      }
    }
    if (a_chg.length) {
      changes.push({ "assignment_id": aid, "changes": a_chg })
    }
  });
  $("#id_change_log").val(JSON.stringify( {
    'user_id': {{ user.id }},
    'delete_ids': $.map($("[id^=dustbin-]"), function (k, v) { if ($(k).prop("checked")) { return $(k).attr('id').split('-', 2)[1] } }),
    'changes': changes
  }));
});
{# keep toggler values up to date #}
$("input[id^=remove_collected-]").change(function () {
  $( this ).val( $( this ).prop("checked") );
	console.log( this );
}).change();
// loop over all linked datetime picker widgets
document.querySelectorAll('[id^="linkedPickers1-"]').forEach(function(linkedPicker1Element) {
  const linked1 = new tempusDominus.TempusDominus(linkedPicker1Element, {
		//restrictions: {
		//minDate: '2022-08-19T12:00:00.000Z',
		//},
	   // format: 'YYYY-MM-DD HH:mm',
        display: {
	    components: {
                useTwentyfourHour: true,
            },
            icons: {
                time: 'bi bi-clock',
                date: 'bi bi-calendar',
                up: 'bi bi-arrow-up',
                down: 'bi bi-arrow-down',
                previous: 'bi bi-chevron-left',
                next: 'bi bi-chevron-right',
                today: 'bi bi-calendar-check',
                clear: 'bi bi-trash',
                close: 'bi bi-x'
            },
            buttons: {
                today: true,
                clear: true,
                close: true
            },
        }
    });
  const id_model = linkedPicker1Element.id.replace('linkedPickers1-', "");
  const old_val = document.getElementById("valid_from-old-" + id_model).value;
  if (old_val.length) {
	var DateTimeVal1 = moment(old_val, 'YYYY-MM-DD HH:mm').toDate();
        linked1.dates.setValue(tempusDominus.DateTime.convert(DateTimeVal1));
	console.log(linked1.dates);
  }
  const id_other = linkedPicker1Element.id.replace('linkedPickers1-', 'linkedPickers2-');
  const linked2 = new tempusDominus.TempusDominus(document.getElementById(id_other), {
        useCurrent: false,
        display: {
	    components: {
                useTwentyfourHour: true,
            },
            icons: {
                time: 'bi bi-clock',
                date: 'bi bi-calendar',
                up: 'bi bi-arrow-up',
                down: 'bi bi-arrow-down',
                previous: 'bi bi-chevron-left',
                next: 'bi bi-chevron-right',
                today: 'bi bi-calendar-check',
                clear: 'bi bi-trash',
                close: 'bi bi-x'
            },
            buttons: {
                today: true,
                clear: true,
                close: true
            }
        }
    });
  const old_val2 = document.getElementById("expires_at-old-" + id_model).value;
  if (old_val2.length) {
	  console.log(old_val2);
	var DateTimeVal2 = moment(old_val2, 'YYYY-MM-DD HH:mm').toDate();
        linked2.dates.setValue(tempusDominus.DateTime.convert(DateTimeVal2));
  }
  
    //using event listeners
  linkedPicker1Element.addEventListener(tempusDominus.Namespace.events.change, (e) => {
        linked2.updateOptions({
            restrictions: {
                minDate: e.detail.date
            }
        });
  });
  
    //using subscribe method
  const subscription = linked2.subscribe(tempusDominus.Namespace.events.change, (e) => {
        linked1.updateOptions({
            restrictions: {
                maxDate: e.date
            }
        });
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/js/bootstrap5-toggle.min.js"></script>
{% endblock %}
