{% extends "report_layout.html" %}

{% block head_content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/css/bootstrap5-toggle.min.css" rel="stylesheet">
{% endblock %}


{# the search bar #}
{% block search %}
{% if reports %}
<div class="card border border-light border-3 mx-5 mb-3 rounded-3">
  <div class="input-group">
    <span class="input-group-text"><span class="bi bi-search"></span></span>
    <input class="form-control" type="text" id="search_report" placeholder="Search by report title, creator or tag" title="Type in a name" autofocus >
    <span class="input-group-text">
      {# toggler to narrow selection according to creator #}
      <input id="toggler-user_creator" data-size="mini" data-width="100"
             type="checkbox" data-toggle="toggle" name="search_creator"
             data-on="Your reports"
             data-off="All reports"
             data-onstyle="success" data-offstyle="secondary">
    </span>
  </div>
</div>
  {# FIXME: a list of most popular tags #}
{% endif %}
{% endblock %}


{# render the report cards #}
{% block bodycontent %}
<div id="reportListPane" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 w-100 mx-auto justify-content-center">
  {% if reports %}
    {% for report in reports %}
      <div class="col" id="hideable-report-{{ report.id }}">
        {% include 'partial_list.html' %}
      </div>
    {% endfor %}
  {% else %}
    {% include 'empty.html' %}
  {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
{# show buttons on mouse enter the transparent card #}
$("div[id^=hideable-report-]").mouseenter(function() {
  var reportid = $( this ).attr("id").split("-", 3)[2];
  // console.log( "card enter: " + reportid );
  bar = $( "#buttonbar-" + reportid );
  bar.removeClass("d-none");
});

{# hide buttons on mouse leaving the transparent card #}
$("div[id^=hideable-report-]").mouseleave(function() {
  var reportid = $( this ).attr("id").split("-", 3)[2];
  // console.log( "card leave: " + reportid );
  bar = $( "#buttonbar-" + reportid );
  bar.addClass("d-none");
});

{# clickng the visible card opens the report #}
$("div[id^=click-report-]").click(function() {
  var reportid = $( this ).attr("id").split("-", 3)[2];
  var url = $( "#url-reportopen-" + reportid).val();
  console.log( "card clicked: " + url );
  var win = window.open(url, '_blank');
  if (win) {
    win.focus();
  }
});

{# when mouse enters the visible card change the cursor to pointer #}
$("div[id^=click-report-]").mouseenter(function() {
  $( this ).css("cursor", "pointer");
});

{# set visibility states for all cards #}
function is_visible_callback(obj, obj_id, pattern_is_empty, match) {
  narrow_creator = B($( "#toggler-user_creator" )[0].checked);
  is_creator = B($( "#report-iscreator-" + obj_id).val());
  return match && ((! narrow_creator) || is_creator);
};

{# narrow selection whether user is the creator of the report #}
$("#toggler-user_creator").change(function() {
  $("#search_report").keyup();
  set_visibility("report");
}).change();                    // invoked just in case the page was reloaded for some reasons and to hide the necessary cards 

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/js/bootstrap5-toggle.min.js"></script>
{% endblock %}

