{% extends "project_layout.html" %}
{% load render_table from django_tables2 %}
{% load extras %}

{% block head_content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/css/bootstrap5-toggle.min.css" rel="stylesheet">
{% endblock %}

{% block bodycontent %}
<div class="container card shadow p-3 mt-3 mb-3 bg-light rounded">
  <form id="project-manage" class="form-horizontal was-validated" action="{{ url_post }}" method="post">
    {% csrf_token %}
    {% title_with_button "You are now configuring <em>" project.name "</em> project" %}
    <ul class="nav nav-tabs" id="projectConfigTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link mytab {% if active == "meta" %}active{% endif %}" 
           id="tab-meta" data-bs-toggle="tab" href="#meta" role="tab" aria-controls="meta" 
           aria-selected="{% if active == "meta" %}true{% else %}false{% endif %}">Meta</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link mytab {% if active == "collaboration" %}active{% endif %}" 
           id="tab-collaboration" data-bs-toggle="tab" href="#collaboration" role="tab" aria-controls="collaboration" 
           aria-selected="{% if active == "collaboration" %}true{% else %}false{% endif %}">Collaboration</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link mytab {% if active == "service" %}active{% endif %}"
           id="tab-service" data-bs-toggle="tab" href="#service" role="tab" aria-controls="service" 
           aria-selected=""{% if active == "service" %}true{% else %}false{% endif %}>Environments</a>
      </li>
  {% if project.id %}
      <li class="nav-item {% if active == "delete" %}active{% endif %}" role="presentation" aria-selected="{% if active == "delete" %}true{% else %}false{% endif %}">
        <a class="nav-link mytab text-danger" id="tab-delete" data-bs-toggle="tab" href="#delete" role="tab" aria-controls="delete" aria-selected="false">Delete</a>
      </li>
  {% endif %}
    </ul>
    <div class="tab-content mt-3" id="projectConfogTabsContent">
      <div class="tab-pane fade {% if active == "meta" %}show active{% endif %}" id="meta" role="tabpanel" aria-labelledby="tab-meta">
        <div class="container-fluid">
          <div class="row row-cols-1 row-cols-md-2">
  	  <div class="col">
              <table>
                {{ form.as_table }}
              </table>
            </div>
  	  <div class="col"> {# hide if small #}
              <div data-toggle="tooltip" title="Please select an option from the image dropdown to check its description." class="d-flex bg-warning rounded p-2 w-100 mt-2 mt-md-0">
                <p class="fw-bolder">Image description:&nbsp;</p>
                <p id="imageDescription"></p>
                <img id="imageThumbnail" alt="TODO">
                {{ form.descriptions }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade {% if active == "collaboration" %}show active{% endif %}" id="collaboration" role="tabpanel" aria-labelledby="tab-collaboration">
        <div class="container-fluid">
          <div class="row row-cols-1 row-cols-md-2">
  	  <div class="col">
              <div class="input-group">
                <span class="input-group-text"><span class="bi bi-search"></span></span>
                <input class="form-control" type="text" id="search_collaborator" placeholder="Search collaborator" title="Type in a name">
              </div>
              {% render_table form.t_users %}
            </div>
            <div class="col">
              {% render_table form.t_collaborators %}
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade {% if active == "service" %}show active{% endif %}" id="service" role="tabpanel" aria-labelledby="tab-service">
        {% if form.t_services %}
        <div class="input-group">
          <span class="input-group-text"><span class="bi bi-search"></span></span>
          <input class="form-control" type="text" id="search_container" placeholder="Search environment" title="Type in a name" >
        </div>
        <div>
          {% render_table form.t_services %}
        </div>
        {% else %}
        <p>You'll need to <a href="{% url 'container:new' %}">create</a> an environment first.</p>
        {% endif %}
      </div>
  {% if container.id %}
      <div class="tab-pane fade {% if active == "delete" %}show active{% endif %}" id="delete" role="tabpanel" aria-labelledby="tab-delete">
        <p>Delete your project by clicking the dustbin...</p>
        {% button_project_delete project %}
      </div>
  {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script> 
{# check if widget belongs to collaborator table #}
function tc(obj, levels = 5) {
  return $(obj).parents().eq(levels).attr('id') === 'collaborators';
}

{# when image selection changes, render appropriate image descriptions #}
$("select[name='preferred_image']").change(function() {
  $( "#id_preferred_image option:selected" ).each(function() {
    id = $(this).attr("value");
    if (id === "") {
      $("#imageDescription").text("");
    } else {
      description = $("#image-description-" + id).attr("value");
      $("#imageDescription").text(description);
    }
  });
}).change();

{# catch submit event, in order to fill properly the share volume information #}
$("#project-manage").submit(function (e) {
  bind_container_ids = $.map($("input[id^=containertoggler-]"), function (k, v) { if ($(k).prop('checked')) { return $(k).val() } }); 
  bind_user_ids = $.map($("input[id^=admin-]"), function (k, v) { if (tc(k)) { return $(k).val(); } });
  admin_users = $.map($("input[id^=admin-]"), function (k, v) { if (tc($(k))) { if ($(k).prop('checked')) { return $(k).val() } }; }); 
  $("#id_project_config").val(JSON.stringify( {
    'user_id': {{ user.id }},
    'project_id': "{{ project.id }}",
    'bind_container_ids': bind_container_ids,
    'bind_user_ids': bind_user_ids,
    'admin_users': admin_users
  }));
});

{# remember which tab was active #}
$("#projectConfigTabs li a").on("click", function () {
  tab = $( this ).attr("id").split('-', 2)[1]
  console.log( tab )
  $.cookie("configure_project_tab", tab, { 'path': '/;SameSite=Strict', 'secure': true });
});

{# handle clicking on table rows #}
$("span[id^='userid-'").click(function() {
  userid = $( this ).attr("id").split("-", 2)[1];
  w_admin = $("#admintoggler-" + userid);
  tr = $( this ).parent().parent();
  table_id = tr.parent().parent().attr("id");
  console.log( table_id );
  if (table_id === "users") {
    other_table = $("#collaborators");
    w_admin.removeClass("d-none");
  } else {
    other_table = $("#users");
    w_admin.addClass("d-none");
  }
  other_table.children("tbody").append(tr);
});

{# hide all table rows except for those matching #}
function is_visible_callback(obj, obj_id, is_empty, is_found) {
  if (obj == 'collaborator') {
    if (tc($("input[id$=collaborator-isshown-" + obj_id), 3)) {
      return true;
    }
    if (is_empty) {
      return false;
    }
    return is_found;
  }
  if (obj == 'container') {
    return is_found;
  }
  return true;
}
{# trigger set_visibility #}
$("#search_collaborator").keyup();
$("#search_container").keyup();

{# rewrite table header #}
$(document).ready(function() {
  $("#users").find("th").text("Users");
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/js/bootstrap5-toggle.min.js"></script>
</div>
{% endblock %}
