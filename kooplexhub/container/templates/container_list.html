{% extends "container_layout.html" %}

{% load static %}


{# the search bar #}
{% block search %}
{% if containers %}
<div class="card border border-light border-3 mx-5 mb-3 rounded-3">
  <div class="input-group">
    <div class="input-group-prepend">
      <div class="input-group-text"><span class="bi bi-search"></span></div>
    </div>
    <input class="form-control" type="text" id="search_container" placeholder="Search by container name" autofocus value="{{ search_container }}">
  </div>
  {# FIXME: toggler to narrow selection according to whether a report container #}
</div>
{% endif %}
{% endblock %}


{# render the container cards #}
{% block bodycontent %}
<div id="containerListPane" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 w-100 mx-auto justify-content-center">
  {% if containers %}
    {% for container in containers %}
      <div class="col" id="hideable-container-{{ container.id }}">
        {% include partial %} {# FIXME: partial as a variable breaks code symmetry with report #}
      </div>
    {% endfor %}
  {% else %}
    {% include 'empty.html' %}
  {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
containerSocket = open_ws('{{ wss_container }}', ws_callback);

{# make sure search string we got gets applied #}
$("#search_container").keyup();

{# open a container #}
function open_container(containerid) {
  var url = $( "#url-containeropen-" + containerid).val();
  console.log( "opening: " + url );
  var win = window.open(url, '_blank');
  if (win) {
    win.focus();
  }
}

{# handle websocket callback #}
function ws_callback(data) {
  //console.log(data);
  var command = data['command'];
  var msg = data['message'];
  var containerid = data['container-id'];
  //console.log('SOCK: --> ' + command + ": " + msg);
  if (command == 'container-log') {
    var widget_msg = $("#container-summary-" + containerid);
    var widget_log = $("#container-logmessage-" + containerid);
    widget_msg.text(msg);
    widget_log.text(data['podlog']);
    console.log(containerid + " -> " + msg);
    setTimeout(function() {
      spinner_state('log', containerid, true);
    }, 2500); // after the model is updated we waith for some time before we reenable refresh log button
  } 
  if (data['state'] == 'np') { //FIXME: Container.ST_NOTPRESENT
    buttons_np(containerid);
  } if (data['state'] == 'run') { //FIXME: Container.ST_RUNNING
    buttons_op(containerid);
  }
};

{# enable or diasble spinner button #}
function spinner_state(btn, containerid, enabled) {
  var widget = $("#container-" + btn + "-" + containerid);
  var spinner = $("#spinner-" + btn + "-" + containerid);
  if (enabled) {
    spinner.addClass("d-none");
    widget.removeClass("d-none");
    widget.parent().attr("disabled", false);
  } else {
    spinner.removeClass("d-none");
    widget.addClass("d-none");
    widget.parent().attr("disabled", true);
  }
}

{# disable control buttons, and show spinner for selected button #}
function spin_button(containerid, btn) {
  $("#container-start-" + containerid).parent().attr("disabled", true);
  $("#container-restart-" + containerid).parent().attr("disabled", true);
  $("#container-stop-" + containerid).parent().attr("disabled", true);
  spinner_state(btn, containerid, false);
}

{# enable buttons and show start button face #}
function buttons_np(containerid) {
  spinner_state('start', containerid, true);
  spinner_state('restart', containerid, true);
  spinner_state('stop', containerid, true);
  $("#container-open-" + containerid).addClass('d-none');
}

{# enable buttons and show open button face #}
function buttons_op(containerid) {
  spinner_state('start', containerid, true);
  spinner_state('restart', containerid, true);
  spinner_state('stop', containerid, true);
  $("#container-start-" + containerid).addClass('d-none');
  $("#container-open-" + containerid).removeClass('d-none');
}

{# refresh logs #}
$("div[id^=containerInfoModal-]").on('shown.bs.modal', function() {
  if (containerSocket.readyState != 1) {
    console.log("Socket not open: " + containerSocket.readyState);
    containerSocket = open_ws('{{ wss_container }}', ws_callback);
  }
  var containerid = $( this ).attr('id').split('-', 2)[1];
  spinner_state('log', containerid, false);
  console.log( "log for container: " + containerid );
  containerSocket.send(JSON.stringify({
    'command': 'container-log',
    'container-id': containerid,
  }));
});

{# start/restart/stop/open a container, or refresh log clicked in the modal #}
$("button[name^=container-]").click(function() {
  var containerid = $( this ).val();
  var command = $( this ).attr("name");
  if (command == "container-start" && ! $("#container-open-" + containerid).hasClass('d-none')) {
    open_container(containerid);
    return;
  }
  if (containerSocket.readyState != 1) {
    console.log("Socket not open: " + containerSocket.readyState);
    containerSocket = open_ws('{{ wss_container }}', ws_callback);
  }
  console.log( command + ": " + containerid );
  var btn = command.split('-', 2)[1];
  spin_button(containerid, btn);
  containerSocket.send(JSON.stringify({
    'command': command,
    'container-id': containerid,
  }));
});

{# on mouse over the card show the buttonbars #}
$("div[id^=hideable-container-]").mouseenter(function() {
  var containerid = $( this ).attr("id").split("-", 3)[2];
  // console.log( "card enter: " + containerid );
  bar = $( "#buttonbar-" + containerid );
  bar.removeClass("d-none");
});

{# hide buttons on mouse leaving the card #}
$("div[id^=hideable-container-]").mouseleave(function() {
  var containerid = $( this ).attr("id").split("-", 3)[2];
  // console.log( "card leave: " + containerid );
  bar = $( "#buttonbar-" + containerid );
  bar.addClass("d-none");
});

{# check if the card belongs to a running container #}
function is_running(w) {
  var containerid = $(w).attr('id').split('-', 3)[2];
  return ! $("#container-open-" + containerid).hasClass('d-none');
}

{# when mouse enters the clickable part of the card change the cursor to pointer #}
$("div[id^=click-]").mouseenter(function() {
  if (is_running(this)) {
    $( this ).css("cursor", "pointer");
  }
});

{# clickng the card header/body opens the environment #}
$("div[id^=click-]").click(function() {
  if (is_running(this)) {
    open_container( $( this ).attr("id").split("-", 3)[2] );
  }
});

</script>
{% endblock %}
